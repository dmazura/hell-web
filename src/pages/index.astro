---
import "../styles/global.css";
import ImageBand from "../components/ImageBand.astro";
import TextBlock from "../components/TextBlock.astro";
import circlesCopyRaw from "../../circles-copy.md?raw";
import circleDescriptionsRaw from "../../circle-description.md?raw";

type CircleCopy = {
  title: string;
  description: string;
};

const circleImageByTitle = {
  Limbo: "/images/01-Limbo.webp",
  Lust: "/images/02-Lust.webp",
  Gluttony: "/images/03-Gluttony.webp",
  Greed: "/images/04-Greed.webp",
  Wrath: "/images/05-Wrath.webp",
  Heresy: "/images/06-Heresy.webp",
  Violence: "/images/07-Violence.webp",
  Fraud: "/images/08-Fraud.webp",
  Treachery: "/images/09-Treachery.webp",
} as const;

const circleStyleByTitle = {
  Violence: "--pos: 40% 45%;",
  Fraud: "--pos: 60% 45%;",
  Treachery:
    "--pos: 35% 45%; --pos-lg: 50% 45%; --vh: 55vh; --vh-sm: 50vh; --vh-md: 50vh; --vh-lg: 40vh;",
} as const;

const circleCaptionByTitle = parseCircleDescriptions(circleDescriptionsRaw);

const circles = parseCircleCopy(circlesCopyRaw)
  .map((circle) => {
    const src = circleImageByTitle[circle.title as keyof typeof circleImageByTitle];
    const style = circleStyleByTitle[circle.title as keyof typeof circleStyleByTitle];
    const caption = circleCaptionByTitle[circle.title] ?? "";
    return src ? { ...circle, src, style, caption } : null;
  })
  .filter(
    (circle): circle is CircleCopy & { src: string; style?: string; caption: string } =>
      circle !== null
  );

function parseCircleCopy(markdown: string): CircleCopy[] {
  const blocks = markdown
    .split(/^##\s+/m)
    .map((block) => block.trim())
    .filter(Boolean);

  const circles: CircleCopy[] = [];
  for (const block of blocks) {
    const lines = block
      .split(/\r?\n/)
      .map((line) => line.trim())
      .filter(Boolean);

    const title = lines[0];
    const rest = lines.slice(1).join(" ");
    const dashMatch = rest.match(/â€”\s*(.*)$/);
    const description = (dashMatch ? dashMatch[1] : rest).trim();

    if (title && description) circles.push({ title, description });
  }
  return circles;
}

function parseCircleDescriptions(markdown: string): Record<string, string> {
  const blocks = markdown
    .split(/^###\s+/m)
    .map((block) => block.trim())
    .filter(Boolean);

  const captions: Record<string, string> = {};
  for (const block of blocks) {
    const lines = block
      .split(/\r?\n/)
      .map((line) => line.trim())
      .filter(Boolean);

    const title = lines[0];
    const caption = lines.slice(1).join(" ").trim();
    if (title && caption) captions[title] = caption;
  }
  return captions;
}
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#0E0F12" />
    <title>Dantes Hell</title>
    <link rel="icon" type="image/png" href="/favicon.png" />
  </head>
  <body>
    <main class="page">
      <section class="content-section">
        <ImageBand
          class="section-image--feather-bottom"
          src="/images/00-Heaven.webp"
          alt="Heaven"
          zoom={false}
        />
      </section>

      {
        circles.map(({ title, description, src, style, caption }) => (
          <section class="content-section">
            <TextBlock>
              <h2>{title}</h2>
              <p>{description}</p>
            </TextBlock>
            <ImageBand
              class="section-image--feather section-image--cinematic"
              src={src}
              alt={title}
              style={style}
            />
            {caption ? (
              <div class="section-image-caption">
                <div class="section-image-caption__inner">{caption}</div>
              </div>
            ) : null}
          </section>
        ))
      }

      <section class="content-section">
        <ImageBand
          class="section-image--feather"
          src="/images/10-Lucifer.webp"
          alt="Lucifer"
        />
      </section>

      <section class="content-section">
        <ImageBand
          class="section-image--feather section-image--cinematic"
          src="/images/11-lucifer-angel.webp"
          alt="Lucifer Angel"
          style="--pos: 35% 45%;"
        />
      </section>

      <section class="content-section">
        <ImageBand
          class="section-image--feather"
          src="/images/12-Friends.webp"
          alt="Friends"
        />
      </section>
    </main>
    <div class="zoom-overlay" data-zoom-overlay>
      <img class="zoom-overlay__image" alt="" />
    </div>
    <script is:inline>
      (() => {
        const overlay = document.querySelector("[data-zoom-overlay]");
        const zoomed = overlay?.querySelector("img");
        if (!overlay || !zoomed) return;
        const open = (img) => {
          zoomed.src = img.currentSrc || img.src;
          zoomed.alt = img.alt || "";
          overlay.dataset.open = "true";
          document.body.dataset.zoomOpen = "true";
        };
        const close = () => {
          overlay.dataset.open = "false";
          document.body.dataset.zoomOpen = "false";
          zoomed.src = "";
          zoomed.alt = "";
        };
        document.addEventListener("click", (event) => {
          const target = event.target;
          if (target instanceof HTMLImageElement && target.dataset.zoom !== undefined) {
            open(target);
          }
        });
        overlay.addEventListener("click", (event) => {
          if (event.target === overlay) close();
        });
        document.addEventListener("keydown", (event) => {
          if (event.key === "Escape") close();
        });
      })();
    </script>
    <!-- Cloudflare Web Analytics -->
    <script
      defer
      src="https://static.cloudflareinsights.com/beacon.min.js"
      data-cf-beacon='{"token": "9330f49bd6944947afafd6b1565489c6"}'
    ></script>
    <!-- End Cloudflare Web Analytics -->
  </body>
</html>
